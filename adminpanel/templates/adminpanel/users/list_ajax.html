{% extends "adminpanel/admin_base.html" %}
{% load static %}

{% block page_title %}Пользователи{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'adminpanel/css/users.css' %}">
<link rel="stylesheet" href="{% static 'ajax_datatable/datatables.min.css' %}">
{% endblock %}

{% block content %}
<div class="users-page">
  <div class="users-header-bar">
    <h2 class="users-title">Пользователи</h2>
    <nav class="users-breadcrumbs">
      <a href="{% url 'adminpanel:dashboard' %}">Главная</a> → <span>Пользователи</span>
    </nav>
  </div>

  <div class="users-toolbar">
    <a class="btn btn-success" href="{% url 'adminpanel:user_add' %}">Создать пользователя</a>
  </div>

  <div class="users-table card">
    <table id="users-table" class="table table-striped table-hover" width="100%">
      <thead>
        <tr>
          <th>#</th>
          <th>Пользователь</th>
          <th>Роль</th>
          <th>Телефон</th>
          <th>Email (логин)</th>
          <th>Статус</th>
          <th class="text-end">Действия</th>
        </tr>
        <tr class="users-filters">
          <th></th>
          <th><input class="inp" id="f-name"  type="text"></th>
          <th>
            <div class="select-wrap">
              <select class="inp" id="f-role">
                <option value="">—</option>
                {% for r in roles %}<option value="{{ r.id }}">{{ r.name }}</option>{% endfor %}
              </select><span class="chev">▾</span>
            </div>
          </th>
          <th><input class="inp" id="f-phone" type="text"></th>
          <th><input class="inp" id="f-email" type="text"></th>
          <th>
            <div class="select-wrap">
              <select class="inp" id="f-status">
                <option value="">—</option>
                <option value="active">Активен</option>
                <option value="disabled">Отключен</option>
              </select><span class="chev">▾</span>
            </div>
          </th>
          <th class="users-filters__right">
            <button class="btn users-clear" id="f-clear">Очистить</button>
          </th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'ajax_datatable/datatables.min.js' %}"></script>
<script>
(function(){
  function getCookie(name){
    const m=document.cookie.match('(^|;)\\s*'+name+'\\s*=\\s*([^;]+)'); return m?m.pop():'';
  }
  const csrftoken = getCookie('csrftoken');

  const table = $('#users-table').DataTable({
    processing: true,
    serverSide: true,
    order: [[0, 'asc']],
    pageLength: 25,
    ajax: {
      url: "{% url 'adminpanel:user_data' %}",
      type: "POST",
      headers: {"X-CSRFToken": csrftoken},
      data: function(d){
        d.q_name   = $('#f-name').val();
        d.q_phone  = $('#f-phone').val();
        d.q_email  = $('#f-email').val();
        d.q_role   = $('#f-role').val();
        d.q_status = $('#f-status').val();
      }
    },
    columns: [
      {data: "id"},
      {data: "full_name"},
      {data: "role__name"},
      {data: "phone"},
      {data: "email"},
      {data: "is_active"},
      {data: "actions", orderable:false, searchable:false}
    ],
    language: {
      url: "https://cdn.datatables.net/plug-ins/1.13.6/i18n/ru.json"
    }
  });

  // фильтры
  $('#f-name,#f-phone,#f-email').on('keyup change', function(){ table.draw(); });
  $('#f-role,#f-status').on('change', function(){ table.draw(); });
  $('#f-clear').on('click', function(){
    $('#f-name,#f-phone,#f-email').val('');
    $('#f-role,#f-status').val('');
    table.draw();
  });
})();
</script>
{% endblock %}