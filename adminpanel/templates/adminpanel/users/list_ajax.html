{% extends "adminpanel/admin_base.html" %}
{% load static %}
{% block page_title %}
    Пользователи
{% endblock page_title %}
{% block extra_css %}
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <link rel="stylesheet"
          href="https://cdn.datatables.net/1.13.8/css/dataTables.bootstrap5.min.css">
    <style>
    .users-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .users-breadcrumbs {
      color: #6c757d;
      font-size: 0.9rem;
    }

    .users-filters .inp {
      width: 100%;
      padding: .35rem .5rem;
      border: 1px solid #d0d7de;
      border-radius: .35rem;
      background: #fff;
    }

    .users-filters th {
      vertical-align: middle;
    }

    .btn-icon {
      padding: .35rem .45rem;
      min-width: auto;
    }

    .btn-icon i {
      font-size: 1rem;
    }

    .users-badge {
      padding: .25rem .5rem;
      border-radius: .35rem;
      font-size: .82rem;
      display: inline-block;
    }

    .users-badge--green {
      background: #e9f7ef;
      color: #117a3a;
    }

    .users-badge--red {
      background: #fff1f2;
      color: #c21b1b;
    }

    .dataTables_wrapper .dataTables_paginate .pagination,
    .dataTables_wrapper .dataTables_paginate .pagination li {
      list-style: none !important;
      margin: 0 !important;
      padding: 0 !important;
    }

    .dataTables_wrapper .dataTables_paginate .pagination li {
      display: inline-block;
      margin-left: .35rem;
    }

    .dataTables_wrapper .dataTables_info {
      margin-top: .45rem;
      color: #6c757d;
    }

    #f-clear {
      display: inline-flex;
      align-items: center;
      gap: .35rem;
    }

    .card {
      border-radius: .6rem;
    }

    .w-56 { width: 56px; }
    .w-220 { width: 220px; }
    .w-180 { width: 180px; }
    .w-260 { width: 260px; }
    .w-140 { width: 140px; }
    .w-150 { width: 150px; }
    </style>
{% endblock extra_css %}
{% block content %}
    <div class="container-fluid">
        <div class="users-header">
            <div>
                <h3 class="mb-1">Пользователи</h3>
                <div class="users-breadcrumbs">
                    <a href="{% url 'adminpanel:dashboard' %}">Главная</a> → Пользователи
                </div>
            </div>
            <a class="btn btn-success" href="{% url 'adminpanel:user_add' %}">
                <i class="bi bi-plus-lg"></i>&nbsp;Создать пользователя
            </a>
        </div>
        <div class="card">
            <div class="card-body p-3">
                <table id="users-table"
                       class="table table-hover table-sm align-middle w-100">
                    <thead>
                        <tr>
                            <th class="w-56">#</th>
                            <th>Пользователь</th>
                            <th class="w-220">Роль</th>
                            <th class="w-180">Телефон</th>
                            <th class="w-260">Email (логин)</th>
                            <th class="w-140">Статус</th>
                            <th class="w-150 text-end">Действия</th>
                        </tr>
                        <tr class="users-filters">
                            <th></th>
                            <th>
                                <input id="f-name" class="inp" placeholder="ФИО / логин">
                            </th>
                            <th>
                                <select id="f-role" class="inp">
                                    <option value="">—</option>
                                    {% for r in roles %}<option value="{{ r.id }}">{{ r.name }}</option>{% endfor %}
                                </select>
                            </th>
                            <th>
                                <input id="f-phone" class="inp" placeholder="+380...">
                            </th>
                            <th>
                                <input id="f-email" class="inp" placeholder="email@...">
                            </th>
                            <th>
                                <select id="f-status" class="inp">
                                    <option value="">—</option>
                                    <option value="active">Активен</option>
                                    <option value="disabled">Отключен</option>
                                </select>
                            </th>
                            <th class="text-end">
                                <button id="f-clear" class="btn btn-outline-secondary btn-sm">
                                    <i class="bi bi-x-circle"></i>
                                    Очистить
                                </button>
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for u in users %}
                            <tr data-role="{% if u.role_id %}{{ u.role_id }}{% endif %}"
                                data-status="{% if u.is_active %}active{% else %}disabled{% endif %}">
                                <td>{{ forloop.counter }}</td>
                                <td>
                                    <a href="{% url 'adminpanel:user_detail' u.pk %}" class="link-primary">
                                        {% if u.get_full_name %}
                                            {{ u.get_full_name }}
                                        {% elif u.username %}
                                            {{ u.username }}
                                        {% else %}
                                            {{ u.email }}
                                        {% endif %}
                                    </a>
                                </td>
                                <td>
                                    {% if u.role_id %}
                                        {{ u.role.name }}
                                    {% else %}
                                        —
                                    {% endif %}
                                </td>
                                <td>{{ u.phone|default:"—" }}</td>
                                <td>{{ u.email|default:"—" }}</td>
                                <td>
                                    {% if u.is_active %}
                                        <span class="users-badge users-badge--green">Активен</span>
                                    {% else %}
                                        <span class="users-badge users-badge--red">Отключен</span>
                                    {% endif %}
                                </td>
                                <td class="text-end">
                                    <div class="btn-group" role="group">
                                        <a class="btn btn-outline-secondary btn-icon btn-sm"
                                           href="{% url 'adminpanel:user_detail' u.pk %}"
                                           title="Просмотр">
                                            <i class="bi bi-eye"></i>
                                        </a>
                                        <a class="btn btn-outline-secondary btn-icon btn-sm"
                                           href="{% url 'adminpanel:user_edit' u.pk %}"
                                           title="Редактировать">
                                            <i class="bi bi-pencil"></i>
                                        </a>
                                        <form action="{% url 'adminpanel:user_delete' u.pk %}"
                                              method="post"
                                              onsubmit="return confirm('Удалить пользователя?');"
                                              class="d-inline">
                                            {% csrf_token %}
                                            <button class="btn btn-outline-danger btn-icon btn-sm" title="Удалить">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                        {% empty %}
                            <tr>
                                <td colspan="7" class="text-center text-muted py-4">Пользователей не найдено</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
{% endblock content %}
{% block extra_js %}
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.8/js/dataTables.bootstrap5.min.js"></script>
    <script>
    (function () {
      const $tbl = $('#users-table');
      const dt = $tbl.DataTable({
        pageLength: 10,
        order: [[0, 'asc']],
        dom: 'rtip',
        language: { paginate: { previous: 'Previous', next: 'Next' } }
      });

      function getFilters() {
        return {
          name: ($('#f-name').val() || '').toLowerCase(),
          role: ($('#f-role').val() || ''),
          phone: ($('#f-phone').val() || '').toLowerCase(),
          email: ($('#f-email').val() || '').toLowerCase(),
          stat: ($('#f-status').val() || '')
        };
      }

      $.fn.dataTable.ext.search.push(function (settings, data, dataIndex) {
        if (settings.nTable !== $tbl[0]) return true;
        const f = getFilters();
        const tr = settings.aoData[dataIndex].nTr;
        const $tr = $(tr);
        const name = (data[1] || '').toLowerCase();
        const role = String($tr.data('role') || '');
        const phone = (data[3] || '').toLowerCase();
        const email = (data[4] || '').toLowerCase();
        const stat = String($tr.data('status') || '');
        return (!f.name || name.indexOf(f.name) !== -1) &&
               (!f.role || role === f.role) &&
               (!f.phone || phone.indexOf(f.phone) !== -1) &&
               (!f.email || email.indexOf(f.email) !== -1) &&
               (!f.stat || stat === f.stat);
      });

      const debounce = (fn, t = 200) => {
        let id;
        return (...a) => {
          clearTimeout(id);
          id = setTimeout(() => fn(...a), t);
        };
      };
      const redraw = debounce(() => dt.draw(), 200);

      $('#f-name,#f-phone,#f-email').on('input', redraw);
      $('#f-role,#f-status').on('change', redraw);
      $('#f-clear').on('click', function () {
        $('#f-name,#f-phone,#f-email').val('');
        $('#f-role,#f-status').val('');
        dt.draw();
      });
    })();
    </script>
{% endblock extra_js %}
